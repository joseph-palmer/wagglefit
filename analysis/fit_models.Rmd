# Fitting waggle dance models to waggle dance data
## Joseph Palmer
---


```{r, include = FALSE}
devtools::load_all()

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(ggplot2)
theme_set(
  theme_classic() +
    theme(
      text = element_text(family = "URWHelvetica", size = 8)
    )
)
library(cowplot)
library(dplyr)
library(tibble)
source("analysis/fit_data.R")

```

## Trial run of a single site using new routine

Using the new routine in this branch (using Nelder-Mead simplex rather than COBYLA) and seperatly optimising p.

```{r}
# Run model analysis lots and lots of times.
use_upper <- 50

bel <- get_data() %>%
  filter(site == "BEL")

result_data <- purrr::map_df(
  seq_len(10),
  ~ {
    print(paste("Itteration", .x))
    result <- run_analysis(
      bel, n = 10, upper = use_upper, verbose_r = T, verbose = F
    )
    return(
      data.frame(
        ll = result$fmax,
        p = result$est[1],
        bs = result$est[2],
        br = result$est[3],
        as = result$est[4],
        ar = result$est[5]
      )
    )
  }
)

best_mod <- result_data %>% filter(ll == max(ll))
if (length(best_mod[, 1] > 1)) {
  best_mod <- best_mod[1, ]
}
params <- best_mod %>% select(p, bs, br, as, ar)
solution <- list(
  fmax = best_mod$ll,
  data_name = "all",
  est = params %>% as.double()
)

map_likelihood_space(
  bel$foraging_distance, params, n = 10000, upper = use_upper
)

solution

```

```{r}
# show the fit

make_full_plot(
  bel$foraging_distance,
  list("collective" = solution),
  subplot_coords = c(0.5, 8, -4.5, -2.5)
)


```
