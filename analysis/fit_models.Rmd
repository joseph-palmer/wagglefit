# Fitting waggle dance models to waggle dance data
## Joseph Palmer
---

```{r, include = FALSE}
devtools::load_all()

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(ggplot2)
theme_set(
  theme_classic() +
    theme(
      text = element_text(family = "URWHelvetica", size = 8)
    )
)
library(cowplot)
library(dplyr)
library(tibble)
source("analysis/fit_data.R")


all_data <- as.list(rep(0, 20))

```

## Optimising each site

In this document I have fit the collective and individual model to each site. So al the sites have reasonable likelihood values, however in some cases the fits are simply wrong (i.e. they show the probability of sampling a value greater than on equal to $x$ as increasing in the tail). I need to trouble shoot these with Vincent. I also need to get some advice on how to plot the model fits to the histogram of data.

Would be a good idea to knit this as a single document / run in R studio on the laptop.


### BEL

Provides a good fit on the data. All parameters look central and nicely covered.

```{r}

target_site <- "BEL"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 10, -5.5, -2)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
bel_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[1]] <- bel_model_fits

bel_model_fits

```



### BFI

All parameters look central in the likelihood space and a nice fit is returned.

```{r}

target_site <- "BFI"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.6)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 4.5, -8, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
bfi_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[2]] <- bfi_model_fits

bfi_model_fits

```


### BLO

The individual fit isnt great and the Bs paramater is increasing up to the boundry, indicating it can only really take on a straight line / exponential fit. The parameters for the collective model are fairly central in the likelihood space, the fit looks very good.

```{r}

target_site <- "BLO"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-10, 5)
br_bnds <- c(1.0e-10, 5)
as_bnds <- c(1.0e-5, 5)
ar_bnds <- c(1.0e-10, 1.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 5505)
as_bnds <- c(1.0e-12, 0.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 12, -8., -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
blo_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[3]] <- blo_model_fits

blo_model_fits

```


### BUR

Bs and Br go in oposite directions. E.g. Bs approaches 0 whilst Br approaches an every higher number.

Fit looks good.

```{r}

target_site <- "BUR"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 500)
br_bnds <- c(1.0e-6, 500)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 5.5, -6.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
bur_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[4]] <- bur_model_fits

bur_model_fits

```


### CAD

The collective model roughly follows the individual model but is able to acheive a slightly improved fit to the shoulder, hence it provides a higher likelihood score. The AIC indicates this is overfitting, suggesting the individual model provides a more parsimonious explanation.

$p$ does not approach 1 as one might expect, indicating there is overfitting and so a comparison with an individual model is required.

```{r}

target_site <- "CAD"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 10)
ar_bnds <- c(1.0e-12, 10)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 2)
as_bnds <- c(1.0e-12, 0.8)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 2.5, -5, -1.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
cad_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[5]] <- cad_model_fits

cad_model_fits

```


### GIL

The collective model provides the most parsimonious and best fit.

```{r}

target_site <- "GIL"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.8)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 2.7, -8., -2)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
gil_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[6]] <- gil_model_fits

gil_model_fits

```


### HER

The collective model provides the best fit to the data, but the proportion of scouts is high.

```{r}

target_site <- "HER"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 100)
br_bnds <- c(1.0e-6, 100)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 2)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 5, -6.5, -1.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
her_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[7]] <- her_model_fits

her_model_fits

```


### HHS

Collective model provides the best fit but falls under the tail and shoulder. The individual model strugles to find a good fit, probably due to the tail.

```{r}

target_site <- "HHS"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 50)
br_bnds <- c(1.0e-6, 50)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 6, -6.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
hhs_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[8]] <- hhs_model_fits

hhs_model_fits

```


### HOR

Collective model provides a very good fit, whilst the individual model fails to find much traction. The proportion of scouts goes very low (~3%) suggesting the majority of the colony are following a small number of scouting individuals.

```{r}

target_site <- "HOR"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 4, -9, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
hor_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[9]] <- hor_model_fits

hor_model_fits

```


### MAK

Again the collective model provides a good fit to the data, however, the individual model fits poorly, reducing to an exponential.

```{r}

target_site <- "MAK"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 20)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 5, -6.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
mak_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[10]] <- mak_model_fits

mak_model_fits

```


### MEL

Collective model provides the best fit, however it misses a large section of the shoulder for the tail. The $bs$ parameter wants to go to zero, however when let go bellow 1e-6 the behaviour becomes very erratic and the fit deteriorates.

```{r}

target_site <- "MEL"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 3.5, -7, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
mel_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[11]] <- mel_model_fits

mel_model_fits

```


### MPA

Collective provides the best fit.

```{r}

target_site <- "MPA"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 4.5, -7.2, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
mpa_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[12]] <- mpa_model_fits

mpa_model_fits

```

### ROT

Colletive provides the best fit.

```{r}

target_site <- "ROT"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 3., -5.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
rot_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[13]] <- rot_model_fits

rot_model_fits

```


### SAU

Collective provides the best fit.

```{r}

target_site <- "SAU"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 3.5, -6.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
sau_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[14]] <- sau_model_fits

sau_model_fits

```

### SOM

Collective provides the best fit but misses a large section of the shoulder.

```{r}

target_site <- "SOM"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site) %>%
  filter(foraging_distance < 9) # remove outlier distance

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 3., -5.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
som_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[15]] <- som_model_fits

som_model_fits

```

### SRA

Collective provides the best fit.

```{r}

target_site <- "SRA"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 4., -7.5, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
sra_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[16]] <- sra_model_fits

sra_model_fits

```

### STU

Individual provides the best fit. Again, the proportion of scouts does not move towards 1. I.e. the collective model fails to reduce to the individual in the MLE fit.

```{r}

target_site <- "STU"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12,10)
ar_bnds <- c(1.0e-12, 10)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 5.5, -6.5, -1.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
stu_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[17]] <- stu_model_fits

stu_model_fits

```

### SWP

Collective provides the best fit.

```{r}

target_site <- "SWP"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 15)
br_bnds <- c(1.0e-6, 15)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 2.5, -6, -2.)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
swp_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[18]] <- swp_model_fits

swp_model_fits

```

### YAL

Collective provides the best fit.

```{r}

target_site <- "YAL"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 5., -8, -2.5)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
yal_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[19]] <- yal_model_fits

yal_model_fits

```

### ZSL

Collective provides the best fit.

```{r}

target_site <- "ZSL"

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# subset data for target site
data <- get_data() %>%
  filter(site == target_site)

# fit collective model
colletive_result <- fit_collective_model_to_data(data, bounds)

# view collective model likelihood space to check bounds look ok
colletive_result$llspace

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 50)
as_bnds <- c(1.0e-12, 1.3)
bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# make plot of model fits
make_full_plot(
  data$foraging_distance,
  list(
    "collective" = colletive_result$solution,
    "individual" = individual_result$solution
  ),
  subplot_coords = c(0.5, 2.4, -8, -2)
)

# calculate ks statistics
ks_test_result_collective <- calc_ks_boot(
  data$foraging_distance, colletive_result$solution$est, "collective"
)
ks_test_result_individual <- calc_ks_boot(
  data$foraging_distance, individual_result$solution$est, "individual"
)

# bring results together
zsl_model_fits <- tibble(
  site = c(target_site, target_site),
  model = c("collective", "individual"),
  loglikelihood = c(
    colletive_result$solution$fmax, individual_result$solution$fmax
  ),
  p = c(colletive_result$solution$est[1], 1),
  k = c(
    length(colletive_result$solution$est),
    length(individual_result$solution$est)
  ),
  AIC = c(
    calc_aic(
      length(colletive_result$solution$est), colletive_result$solution$fmax
    ),
    calc_aic(
      length(individual_result$solution$est), individual_result$solution$fmax
    )
  ),
  ks_statistic = c(
    ks_test_result_collective$ks$statistic[[1]],
    ks_test_result_individual$ks$statistic[[1]]
  ),
  ks_pvalue = c(
    ks_test_result_collective$ks.boot.pvalue,
    ks_test_result_individual$ks.boot.pvalue
  )
)

all_data[[20]] <- zsl_model_fits

zsl_model_fits

```

## Overall findings

```{r}

# group all site results together
df <- all_data %>%
  bind_rows()

# AIC plot
aic_plot <- df %>%
  group_by(site) %>%
  slice(which.min(AIC)) %>%
  select(model) %>%
  group_by(model) %>%
  summarise(lowest_AIC = n()) %>%
  ggplot(aes(x = model, y = lowest_AIC)) +
  geom_bar(stat = "identity") +
  labs(x = "Model", y = "Count") +
  scale_y_continuous(breaks = seq(0, 20, by = 1))

ggsave(
  plot = aic_plot,
  filename = "analysis/figures/AIC_plot.png",
  width = 86,
  height = 90,
  units = "mm",
  dpi = 400
)

# ks plot
ks_plot_dist <- df %>%
  ggplot(aes(x = ks_pvalue)) +
  geom_histogram(bins = 10, binwidth = 0.1, col = "white") +
  geom_vline(xintercept = 0.05, color = "red", linetype = "dashed") +
  scale_y_continuous(breaks = seq(0, 12, by = 2)) +
  labs(x = "KS P value") +
  facet_wrap(~model, nrow = 3)

ggsave(
  plot = ks_plot_dist,
  filename = "analysis/figures/sites_ks.png",
  width = 86,
  height = 180,
  units = "mm",
  dpi = 400
)

```


### Map plots


```{r}

library(ggplot2)
library(cowplot)
library(ggsn)
library(sf)
library(rworldmap)

full_data_path <- "analysis/data/FullHBForagingData.csv"
data_raw <- tibble(read.csv(full_data_path))

map_data <- data_raw %>%
  select(
    site, lat, lon
  ) %>%
  distinct()

map_data <- df %>%
  group_by(site) %>%
  slice(which.min(AIC)) %>%
  select(site, model) %>%
  left_join(map_data, on = "site")

locations <- st_as_sf(
  map_data,
  coords = c("lon", "lat"), crs = 4326
)

zoomed_area <- st_read("analysis/shapefiles/english_region_region.shp")

# cropped
croped_data <- st_crop(
  zoomed_area,
  xmin = 470000,
  xmax = 610000,
  ymin = 130000,
  ymax = 225000
)

# location of sites box
selected_sites <- filter(locations, site %in% c("STU", "ZSL"))
sites_sf_t <- st_transform(
  selected_sites
)

points_area <- st_bbox(locations)

zoom_plt <- ggplot() +
  geom_sf(data = croped_data, fill = "#ededed") +
  geom_sf(data = locations, aes(shape = model), size = 2) +
  geom_sf_text(
    data = selected_sites, aes(label = site),
    nudge_x = c(0.5, 105), nudge_y = c(-0.5, -105)
  ) +
  scale_shape_manual(values = c(2, 17)) +
  theme_nothing() +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    text = element_text(family = "URWHelvetica", size = 8)
  )

zoom_plt

# make full plot
# get underlaying map
worldmap <- getMap(resolution = "high")

base <- ggplot() +
  geom_polygon(data = worldmap,
               aes(x = long, y = lat,
                   group = group),
               fill = '#c4cfc8',
               color = '#4b4949d0') +
  coord_fixed(ratio = 1.8,
              xlim = c(-11, 13),
              ylim = c(50, 59)) +
  geom_point(data = map_data, aes(x = lon, y = lat), size = 0.2) +
  geom_rect(
    aes(
      xmin = points_area$xmin[[1]] - 0.2, xmax = points_area$xmax[[1]] + 0.2,
      ymin = points_area$ymin[[1]] - 0.2, ymax = points_area$ymax[[1]] + 0.2
    ),
    fill = NA,
    colour = "black",
    size = 0.2
  ) +
  theme_nothing() +
  scale_x_continuous(expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = 1)
  )

base

merge_plot <- ggdraw() +
  draw_plot(ggplotGrob(base)) +
  draw_plot(
    ggplotGrob(zoom_plt), x = 0.47, y = 0.35, width = 0.5, height = 0.5
  )

merge_plot

ggsave(
  plot = merge_plot,
  file = "analysis/figures/map_aic.png",
  width = 86,
  height = 90,
  units = "mm",
  dpi = 400
)

ggsave(
  plot = plots[[20]][[1]],
  file = "analysis/figures/ZSL.png",
  width = 86,
  height = 90,
  units = "mm",
  dpi = 400
)

ggsave(
  plot = plots[[17]][[1]],
  file = "analysis/figures/STU.png",
  width = 86,
  height = 90,
  units = "mm",
  dpi = 400
)
```
