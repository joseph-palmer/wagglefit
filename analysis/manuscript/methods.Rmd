---
title: "Forage site distributions quantify collective foraging in honey bee colonies: Methods"
author: "Joseph Palmer, Ash Samuelson, Elli Leadbeater and Vincent Jansen"
output:
  word_document
always_allow_html: true
bibliography: paper-refs.bib
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(showtext)
showtext_auto()

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(ggplot2)
theme_set(
  theme_classic() +
    theme(
      text = element_text(size = 18)
    )
)

library(dplyr)
library(kableExtra)
library(flextable)
library(tibble)
```

# Acknowledgments

# Conflict of interest

The authors declare no conflict of interest.

# Code and data availability

All code for analysis is available on GitHub at (insert link to finalised public github repo or archive). All data is available via the Dryad Digital Repository https://doi.org/10.5061/dryad.c2fqz618f [@Samuelson2021].

# Data collection

Methods for how the data used for this study was collected can be found in full in Materials and Methods sections 2.1, 2.2 and 2.3 of [@Samuelson2021].

## Land-use preference analysis

Methods for how land-use types were classified can be found in Materials and Methods sections 2.6 of [@Samuelson2021].

## Waggle dance decoding

Methods for waggle dance decoding are fully described in Materials and Methods section 2.4 in [@Samuelson2021].

# Simulation

A circular environment is first created with radius $r = 2.5$. The number of flowers in the environment is generated as a random Poisson variable with rate equal to 5000 multiplied by the area of the environment. These are placed on polar coordinates with a uniformly selected angle, $\theta$, between 0 and 2$\pi$ and a radial value, $\rho$, between 0 and $r$, determined from the square root of the uniform position values multiplied by $r$. These polar coordinates are converted to Cartesian coordinates using the formulas $x = \rho\cos(\theta)$ and $y = \rho\sin(\theta$). Each location is then assigned to an instance of a flower object along with a random quality of between 0 and 10. This quality is combined with the distance of the flower to the centrally located hive to form a measure of how profitable the flower is (see model, equation?).

One-hundred honeybee objects are created, 20 of which 20 are scouts and the rest recruits. Scouts leave the environment following a random path through the environment generated by sampling a uniform random step length and angle. The number of paths the scout draws when searching is also determined as a uniform random number. Each straight line in the random path is converted to a rectangle with length equal to the path section length and a constant width of ~0.01 to represent an area the scout searches along that path. Of all the flowers contained in the boxes drawn from the scout's path, the one closest to the colony is selected as the flower the scout will report and will communicate its location if the quality of the flower is $ge$ 0. Flower communication is simulated by pooling together all the flower objects found. If no flowers are contained in the scout's path, they will not add any flowers to the scout pool and draw a new path in the next foraging iteration.

Recruits represent honeybee objects which do not perform the searches the scouts do. Instead, they sample from the pool of flower objects reported by scouts. This sampling is done by selecting flowers with a probability which is skewed towards the profitability of the flower, meaning more profitable flowers have a greater chance of being selected by recruits. Recruits will then visit these flowers and in the next iteration will add their flower to the pool of scout dances. Consequently, the pool of dances represents flowers discovered by scouts and flowers exploited by recruits. When a flower is depleted,

the flower is removed from the environment and so any foragers that were foraging on it would select a different flower from the dance floor.

The simulation was run 100 times and every 5 time steps all distances reported by scouts and recruits were recorded and combined. This was done to reflect the way foraging data is collected in real honeybee studies. We fit an exponential and minimum of an exponential distribution to both the distribution of foraging distances reported by the scout and recruit objects. Fitting was done by deriving the maximum likelihood estimate for each model fit on each data source through their analytical solutions: $\hat{\lambda} = \frac{1}/{\bar{x}}$, minimum of the exponential with a minimum foraging distance: $\hat{\lambda} = \frac{1}{\pi \bar{x^{2}}}$. As the exponential assumes distributions start from 0 the data was transformed to start from 0 by subtracting the minimum foraging distance from all foraging distances ($x = x - min(x)$) before fitting.

All simulation code was written in Python version 3.9 and uses the Pandas [@Mckinney2011] and Scipy [@Jones2001] packages.

# Model

We make the initial assumption that there are $n$ different resources distributed within an environment according to a spatial Poisson point process with rate $\lambda_{I}$ for resource $I$. As a scout travels a small distance $dx$ it will cover an area of $c_sdx$, with $c_s$ depending upon the width of the area scanned, the detection rate and degree to which a scout's path covers new ground. The probability density of the distance travelled after which the first resource is discovered $x$ follows an exponential distribution with a rate derived from the intensity of the flowers within the environment: $\lambda_s e^{-\lambda_s x}$, where $\lambda_s = c_s \sum_{I = 1}^{n} \lambda_I$.

The number of repeats of a dance on the dance floor is dictated by profitability and is defined as the net energy efficiency per amount of energy spent: $\frac{Gain-Cost}{Cost}$. The gain is determined by the sucrose concentration of nectar from a flower, $q$, whilst the cost is determined by the distance, $x$. The energy gained, $G$, is therefore proportional to the quality $q$, whilst the cost increases linearly with distance. We can therefore refactor energy efficiency as $\frac{q}{1+\alpha x}-1$, where $\alpha$ represents the energy spend per distance relative to a fixed cost of travel. As bees should not be expected to dance for a negative profitability, we can derive a function to translate quality and distance into a measure of the number of dances on a dance floor: $\sigma(q,x) = [\frac{q}{1+\alpha x}-1]_+$, where the notation of $[x]_+ = max(x, 0)$. This function has the property that for a fixed $x$ there is a minimum quality $q = 1+\alpha x$ below which bees don't dance. The equivalent quality of two resources at distance $x1$ and $x2$ is $\frac{1+\alpha x2}{1+\alpha x1} = \frac{q2}{q1}$. The critical distance $\epsilon_{ij} = [\frac{1}{\alpha} \frac{qj - qi}{qi}+\frac{qj}{qi} x]_+$.

For a resource of type $I$ located at a distance $x$, the expected number of dances would be $c_s \lambda_I \sigma(qi, x) e^{-\lambda_s x}$. It follows that the expected total number of scout waggle dances on the dance floor is given by: $M_s = \sum_{I=1}^{n} \int_{0}^{\inf} \frac{c_s \lambda_I}{\lambda_s} \sigma(qi, x) \lambda_s e^{-\lambda_s x} dx$. The distribution of scout dances is: $\frac{\lambda_s e^{-\lambda_s x} \sum_{I=1}^{n} \frac{c_s \lambda_I}{\lambda_s} \sigma(qi, x)}{M_s}$.

Using the same logic we derive what the distribution of recruits will look like. If two locations differ in resource quality and distance then a hive can prefer a further location if it is sufficiently better and a lesser quality resource if it is sufficiently nearer. For a site with quality $q_I$ and at distance $x$ from the hive, for a second location with quality $q_j$ this threshold distance $\epsilon_{ij}$ satisfies $\sigma(q_i, x) = \sigma(qj, \epsilon_{ij}$. Consequently, the critical distance is an implicit function of distance and it follows from implicit differentiation that $\frac{d\epsilon_{ij}}{dq_j} = - \frac{d\sigma{q_j,x}/dq{j}}{d\sigma{q,x}/dx} > 0$ and $\frac{d\epsilon_{ij}}{dq_I} = \frac{d\sigma{q_i,x}/dq{i}}{d\sigma{q,x}/dx} < 0$. If $qi = qj$ then $\epsilon_{ij}(x) = x$ and it follows that if $q_I > q_j$ then $\epsilon_{ij} < x$ and if $q_I < q_j$ then $\epsilon_{ij} > x$.  As recruits get their information from scouts (as well as recruits) how well the scouts cover depends upon the number of scouts and how well their collective paths cover an area and the chance of discovery of each resource. To capture this we let the fraction of resources that can be discovered by a collection of scouts be $c_r$ and assume $0 \leq c_r \leq 1$. The probability that there is a not a food source discovered worth reporting on within a radius of $x$ $e^{-c_r \lambda_r \pi \epsilon_{ij}(x)^2}$, where $\lambda_r = \sum_I={1}^{n} \lambda_i$. This function also described the probability of having the nearest food source that the recruits will come out for discovered at least a distance of $x$ away.

# Statistical analysis

All analysis code is written in R [@RCore2020].

## Model fitting

All models are fit using Maximum likelihood estimation [@Burnham2002] by summation of the log of the model function outlined in the methods section: model. The numerical optimisation routine is written in c++ and uses the Nelder-Mead simplex algorithm [@Nelder1965] implemented in the 'NLopt' library [@Johnson2020] and interfaced to R [@RCore2020] using 'Rcpp' [@Eddelbuettel2011].

Model parsimony is assessed using Akaike information criterion (AIC) [@Aho2014] and the model with the lowest AIC score is deemed to be the most parsimonious.

Goodness of fit is assessed using the Kolmorgorov-Smirnov (KS) test [@Goldstein2004] and implemented in R using the ks.boot function of the package Matching in R [@Sekhon2011].

## Partial Least Squares analysis

A key consideration is that our response variable is a proportion and thus lies on the interval $[0, 1]$. This makes it unsuitable for a standard linear regression. One option would be to use a generalized linear regression with a logit link and quasibinomial family. This method is most suited for when the response variable is an integer proportion, where the response variable is a division of two integers, such as the proportion of males within a population. Our measure is in principle an integer proportion as we measure the proportion of scouts, however, this value is an estimate derived from our model and so is continuous on the interval $[0, 1]$. An alternative method would be to transform the proportions on to a continuos scale using the $arcsin \sqrt{x}$ transformation. The most appropriate method would be to use a beta regression which is designed specifically for proportional response variables.

We used the R package plsRbeta [@Bertrand2013] to conduct the partial least squares analysis and performed a beta regression on the results using the R package betareg [@Cribari-Neto2010].

# References
