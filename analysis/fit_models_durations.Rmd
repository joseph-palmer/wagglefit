---
title: Fitting waggle dance models to waggle dance data
author: Joseph Palmer
output:
  html_notebook:
    theme: yeti
    toc: true
    toc_float: true
---

This document contains code to fit the waggle dance model to each of our 20 different sites. The code here uses the wagglefit package, as well as some additional code stored in `fit_data.R` to help simplify things. Each site has its own section, with reused code. The final sections create map plots and summary statistic plots.

```{r, preamble, include = FALSE}
devtools::load_all()

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(ggplot2)
theme_set(
  theme_classic() +
    theme(
      text = element_text(family = "DejaVuSerif", size = 48)
    )
)
library(cowplot)
library(dplyr)
library(tibble)
source("fit_data.R")
library(kableExtra)

library(showtext)
showtext_auto()

run_wagglefit_analysis <- function(target_site, data, collective_bounds, individual_bounds, subplot_coords) {

  # run collective model
  colletive_result <- fit_collective_model_to_data(data, collective_bounds)

  # run individual model
  individual_result <- fit_individual_model_to_data(data, individual_bounds)

  # make plot of model fits
  full_plot <- make_full_plot(
    data$foraging_distance,
    list(
      "collective" = colletive_result$solution,
      "individual" = individual_result$solution
    ),
    subplot_coords = subplot_coords
  )

  # calculate ks statistics
  ks_test_result_collective <- calc_ks_boot(
    data$foraging_distance, colletive_result$solution$est, "collective"
  )
  ks_test_result_individual <- calc_ks_boot(
    data$foraging_distance, individual_result$solution$est, "individual"
  )

  # bring results together
  model_fits <- tibble(
    site = c(target_site, target_site),
    model = c("collective", "individual"),
    loglikelihood = c(
      colletive_result$solution$fmax, individual_result$solution$fmax
    ),
    p = c(colletive_result$solution$est[1], 1),
    bs = c(colletive_result$solution$est[2], individual_result$solution$est[1]),
    br = c(colletive_result$solution$est[3], NA),
    as = c(colletive_result$solution$est[4], individual_result$solution$est[2]),
    ar = c(colletive_result$solution$est[5], NA),
    k = c(
      length(colletive_result$solution$est),
      length(individual_result$solution$est)
    ),
    AIC = c(
      calc_aic(
        length(colletive_result$solution$est), colletive_result$solution$fmax
      ),
      calc_aic(
        length(individual_result$solution$est), individual_result$solution$fmax
      )
    ),
    ks_statistic = c(
      ks_test_result_collective$ks$statistic[[1]],
      ks_test_result_individual$ks$statistic[[1]]
    ),
    ks_pvalue = c(
      ks_test_result_collective$ks.boot.pvalue,
      ks_test_result_individual$ks.boot.pvalue
    )
  )

  return(
    list(
      fit_result = model_fits, fit = full_plot,
      individual_llspace = individual_result$llspace,
      collective_llspace = colletive_result$llspace
    )
  )
}

all_sites <- as.list(rep(0, 20))
names(all_sites) <- get_data() %>%
  select(site) %>%
  unique() %>%
  pull()
```

## Optimising each site

```{r}
# set waggle dance duration in seconds as foraging distance for analysis
data <- read.csv("data/FullHBForagingData.csv")

alldata <- data %>%
  select(date, site, duration.seconds) %>%
  rename(foraging_distance = duration.seconds)
```

### BEL

Provides a good fit on the data. All parameters look central and nicely covered.

```{r, BEL, message = FALSE, warning = FALSE}

target_site <- "BEL"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 8, -5.5, -1.8)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```



### BFI

All parameters look central in the likelihood space and a nice fit is returned.

```{r, BFI, message = FALSE, warning = FALSE}

target_site <- "BFI"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.6)
bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.2, 3.5, -6.5, -2.)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### BLO

The individual fit isnt great and the Bs paramater is increasing up to the boundry, indicating it can only really take on a straight line / exponential fit. The parameters for the collective model are fairly central in the likelihood space, the fit looks very good.

```{r, BLO, message = FALSE, warning = FALSE}

target_site <- "BLO"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-10, 5)
br_bnds <- c(1.0e-10, 5)
as_bnds <- c(1.0e-5, 5)
ar_bnds <- c(1.0e-10, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 5505)
as_bnds <- c(1.0e-12, 0.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.2, 9.5, -8., -2.2)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### BUR

Bs and Br go in oposite directions. E.g. Bs approaches 0 whilst Br approaches an every higher number.

Fit looks good.

```{r, BUR, message = FALSE, warning = FALSE}

target_site <- "BUR"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 500)
br_bnds <- c(1.0e-6, 500)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4, -6.5, -2.2)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### CAD

The collective model roughly follows the individual model but is able to acheive a slightly improved fit to the shoulder, hence it provides a higher likelihood score. The AIC indicates this is overfitting, suggesting the individual model provides a more parsimonious explanation.

$p$ does not approach 1 as one might expect, indicating there is overfitting and so a comparison with an individual model is required.

```{r, CAD, message = FALSE, warning = FALSE}

target_site <- "CAD"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 10)
ar_bnds <- c(1.0e-12, 10)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 2)
as_bnds <- c(1.0e-12, 0.8)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 1.8, -6, -1.2)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### GIL

The collective model provides the most parsimonious and best fit.

```{r, GIL, message = FALSE, warning = FALSE}

target_site <- "GIL"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 0.8)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 2.1, -8., -2)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### HER

The collective model provides the best fit to the data, but the proportion of scouts is high.

```{r, HER, message = FALSE, warning = FALSE}

target_site <- "HER"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 100)
br_bnds <- c(1.0e-6, 100)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 2)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4, -6.5, -1.5)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### HHS

Collective model provides the best fit but falls under the tail and shoulder. The individual model strugles to find a good fit, probably due to the tail.

```{r, HHS, message = FALSE, warning = FALSE}

target_site <- "HHS"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 50)
br_bnds <- c(1.0e-6, 50)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4, -6.5, -2.2)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### HOR

Collective model provides a very good fit, whilst the individual model fails to find much traction. The proportion of scouts goes very low (~3%) suggesting the majority of the colony are following a small number of scouting individuals.

```{r, HOR, message = FALSE, warning = FALSE}

target_site <- "HOR"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 1.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 3, -9, -2.5)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### MAK

Again the collective model provides a good fit to the data, however, the individual model fits poorly, reducing to an exponential.

```{r, MAK, message = FALSE, warning = FALSE}

target_site <- "MAK"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 20)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# run individual model
individual_result <- fit_individual_model_to_data(data, bounds)

# view individual model likelihood space to check bounds look ok
individual_result$llspace

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4.2, -6.5, -2.5)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### MEL

Collective model provides the best fit, however it misses a large section of the shoulder for the tail. The $bs$ parameter wants to go to zero, however when let go bellow 1e-6 the behaviour becomes very erratic and the fit deteriorates.

```{r, MEL, message = FALSE, warning = FALSE}

target_site <- "MEL"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 3., -7, -2.1)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### MPA

Collective provides the best fit.

```{r, MPA, message = FALSE, warning = FALSE}

target_site <- "MPA"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4., -7.2, -2.1)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### ROT

Colletive provides the best fit.

```{r, ROT, message = FALSE, warning = FALSE}

target_site <- "ROT"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 2., -5.5, -2.1)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```


### SAU

Collective provides the best fit.

```{r, SAU, message = FALSE, warning = FALSE}

target_site <- "SAU"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 2.5, -6.5, -2.1)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### SOM

Collective provides the best fit but misses a large section of the shoulder.

```{r, SOM, message = FALSE, warning = FALSE}

target_site <- "SOM"

# subset data for target site
data <- alldata %>%
  filter(site == target_site) %>%
  filter(foraging_distance < 6) # remove outlier distance

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 2., -5.5, -2.1)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### SRA

Collective provides the best fit.

```{r, SRA, message = FALSE, warning = FALSE}

target_site <- "SRA"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 3., -7.5, -2.1)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### STU

Individual provides the best fit. Again, the proportion of scouts does not move towards 1. I.e. the collective model fails to reduce to the individual in the MLE fit.

```{r, STU, message = FALSE, warning = FALSE}

target_site <- "STU"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4, -6.5, -1.5)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### SWP

Collective provides the best fit.

```{r, SWP, message = FALSE, warning = FALSE}

target_site <- "SWP"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 15)
br_bnds <- c(1.0e-6, 15)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 2., -6, -1.5)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### YAL

Collective provides the best fit.

```{r, YAL, message = FALSE, warning = FALSE}

target_site <- "YAL"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.1)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 4., -8, -2.)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

### ZSL

Collective provides the best fit.

```{r, ZSL, message = FALSE, warning = FALSE}

target_site <- "ZSL"

# subset data for target site
data <- alldata %>%
  filter(site == target_site)

# set up bounds for the collective model
p_bnds <- c(0, 1.0)
bs_bnds <- c(1.0e-6, 10)
br_bnds <- c(1.0e-6, 10)
as_bnds <- c(1.0e-12, 1.5)
ar_bnds <- c(1.0e-12, 0.5)
collective_bounds <- rbind(
  p_bnds, bs_bnds,
  br_bnds, as_bnds,
  ar_bnds
)

# set up bounds for the individual model
bs_bnds <- c(1.0e-6, 50)
as_bnds <- c(1.0e-12, 1.3)
individual_bounds <- rbind(
  bs_bnds, as_bnds
)

# set coordinates for histogram subplot
subplot_coords <- c(0.1, 1.8, -8, -2)

all_sites[[target_site]] <- run_wagglefit_analysis(
  target_site, data, collective_bounds, individual_bounds, subplot_coords
)

all_sites[[target_site]]$fit_result %>%
  kbl() %>%
  kable_classic(full_width = F)

all_sites[[target_site]]$fit
```

## Overall findings

```{r, make-plots, message = FALSE, warning = FALSE}
# save the analysis results for all sites
save(all_sites, file = "results/site_fit_results.Rdata")

# group all site results together
df <- map(all_sites, 1) %>%
  bind_rows()

# save results
saveRDS(df, file = "results/site_fit_results.Rda")

# AIC plot
aic_plot <- df %>%
  group_by(site) %>%
  slice(which.min(AIC)) %>%
  select(model) %>%
  group_by(model) %>%
  summarise(lowest_AIC = n()) %>%
  ggplot(aes(x = model, y = lowest_AIC)) +
  geom_bar(stat = "identity") +
  labs(x = "Model", y = "Count") +
  scale_y_continuous(breaks = seq(0, 20, by = 2)) +
  theme(
    text = element_text(size = 42)
  )

ggsave(
  plot = aic_plot,
  filename = "results/figures/AIC_plot.png",
  width = 90,
  height = 110,
  units = "mm",
  dpi = 300
)

# ks plot
ks_plot_dist <- df %>%
  ggplot(aes(x = ks_pvalue)) +
  geom_histogram(bins = 10, binwidth = 0.1, col = "white") +
  geom_vline(xintercept = 0.05, color = "red", linetype = "dashed") +
  scale_y_continuous(breaks = seq(0, 12, by = 2)) +
  labs(x = "KS P value") +
  facet_wrap(~model, nrow = 3) +
  theme(
    text = element_text(size = 42),
    strip.background = element_blank()
  )


ggsave(
  plot = ks_plot_dist,
  filename = "results/figures/sites_ks.png",
  width = 86,
  height = 180,
  units = "mm",
  dpi = 300
)

ggsave(
  plot = all_sites$STU$fit,
  filename = "results/figures/STU.png",
  width = 90,
  height = 110,
  units = "mm",
  dpi = 300
)

ggsave(
  plot = all_sites$ZSL$fit,
  filename = "results/figures/ZSL.png",
  width = 90,
  height = 110,
  units = "mm",
  dpi = 300
)
```


### Map plots


Code to make the individual mal plots. These figures are created standalone but are combined in to facets manually in an image processor.

```{r, map-plots, message = FALSE, warning = FALSE}

library(ggplot2)
library(ggrepel)
library(gridExtra)
library(ggsn)
library(sf)
library(rworldmap)
library(ggspatial)
library(rnaturalearth)
library(rnaturalearthdata)


full_data_path <- "data/FullHBForagingData.csv"
data_raw <- tibble(read.csv(full_data_path))

map_data <- data_raw %>%
  select(
    site, lat, lon
  ) %>%
  distinct()

map_data <- df %>%
  group_by(site) %>%
  slice(which.min(AIC)) %>%
  select(site, model) %>%
  left_join(map_data, on = "site") %>%
  mutate(col = ifelse(site %in% c("STU", "ZSL"), "1", "0"))

locations <- st_as_sf(
  map_data,
  coords = c("lon", "lat"), crs = 4326
)

# Extract selected sites for figure
selected_sites <- filter(map_data, site %in% c("STU", "ZSL")) %>%
  mutate(
    label = ifelse(site == "STU", "C (STU)", "D (ZSL)")
  )

points_area <- st_bbox(locations)

worldmap <- ne_countries(scale = "large", returnclass = "sf")

# london area
london <- st_read(
  "shapefiles/London_Ward.shp"
)

london <- st_transform(
  london,
  CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
)

inset <- ggplot() +
  geom_sf(
    data = worldmap,
    fill = "grey90",
    color = "#4b4949d0"
  ) +
  geom_sf(
    data = london,
    fill = "#ced0cffc",
    lwd = 0
  ) +
  coord_sf(
    xlim = c(points_area[[1]] - 0.1, points_area[[3]] + 0.1),
    ylim = c(points_area[[2]] - 0.1, points_area[[4]] + 0.1)
  ) +
  geom_point(
    data = map_data,
    aes(x = lon, y = lat, shape = model, colour = model), size = 1.5
  ) +
  geom_text(
    data = selected_sites, aes(x = lon, y = lat, label = label),
    nudge_x = c(0, -0.07), nudge_y = c(0.05, 0.05), size = 8
  ) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    style = north_arrow_fancy_orienteering,
    height = unit(15, "mm"),
    width = unit(15, "mm"),
    text_cex = 1.5
  ) +
  annotation_scale(
    location = "br",
    text_cex = 1.5
  ) +
  scale_shape_manual(values = c(1, 2)) +
  scale_colour_manual(values = c("black", "red")) +
  theme_nothing() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = .5)
  )

inset

# make full plot
base <- ggplot(data = worldmap) +
  geom_sf(
    fill = "#c4cfc8",
    color = "#4b4949d0",
    lwd = 0.2
  ) +
  coord_sf(
    xlim = c(-11, 3),
    ylim = c(49.5, 60)
  ) +
  # geom_point(data = map_data, aes(x = lon, y = lat), size = 0.2) +
  geom_rect(
    aes(
      xmin = points_area$xmin[[1]] - 0.1, xmax = points_area$xmax[[1]] + 0.1,
      ymin = points_area$ymin[[1]] - 0.1, ymax = points_area$ymax[[1]] + 0.1
    ),
    fill = NA,
    colour = "black",
    size = .02
  ) +
  theme_nothing() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = .5)
  )

base

merge_plot <- base +
  annotation_custom(
    ggplotGrob(inset),
    xmin = 1,
    xmax = 13,
    ymin = 52.5,
    ymax = 60
  )

merge_plot

ggsave(
  plot = merge_plot,
  filename = "results/figures/site_map.png",
  width = 90,
  height = 110,
  units = "mm",
  dpi = 300
)


merge_plot_2 <- inset +
  annotation_custom(
    ggplotGrob(base),
    xmin = -3.35,
    xmax = 2,
    ymin = 51.05,
    ymax = 51.35
  )

merge_plot_2

sites_model_plot <- plot_grid(
  merge_plot_2, ks_plot_dist, all_sites$STU$fit, all_sites$ZSL$fit,
  labels = c("A", "B", "C", "D"), label_size = 24
)

ggsave(
  plot = sites_model_plot,
  filename = "results/figures/sites_model_plot.png",
  width = 183,
  height = 190,
  units = "mm",
  dpi = 300
)

ggsave(
  plot = sites_model_plot,
  filename = "results/figures/sites_model_plot.svg",
  width = 183,
  height = 190,
  units = "mm",
  dpi = 300
)

model_sites_fits <- plot_grid(
  merge_plot_2, ks_plot_dist,
  labels = c("A", "B"), label_size = 24
)

ggsave(
  plot = model_sites_fits,
  filename = "results/figures/model_sites_fits.png",
  width = 183,
  height = 190,
  units = "mm",
  dpi = 300
)

stu_zsl_fit <- plot_grid(
  all_sites$STU$fit, all_sites$ZSL$fit,
  labels = c("A", "B"), label_size = 24
)

ggsave(
  plot = stu_zsl_fit,
  filename = "results/figures/stu_zsl_fit.svg",
  width = 183,
  height = 190,
  units = "mm",
  dpi = 100
)
```


```{r, eval = FALSE, other-map-plots, message = FALSE, warning = FALSE}
# other map plots
inset <- ggplot() +
  geom_sf(
    data = worldmap,
    fill = "grey90",
    color = "#4b4949d0"
  ) +
  geom_sf(
    data = london,
    fill = "#ced0cffc",
    lwd = 0
  ) +
  coord_sf(
    xlim = c(points_area[[1]] - 0.1, points_area[[3]] + 0.1),
    ylim = c(points_area[[2]] - 0.1, points_area[[4]] + 0.1)
  ) +
  geom_point(
    data = map_data,
    aes(x = lon, y = lat, shape = model, colour = model), size = 1.5
  ) +
  annotation_north_arrow(
    location = "tr", which_north = "true",
    style = north_arrow_fancy_orienteering,
    height = unit(10, "mm"),
    width = unit(10, "mm")
  ) +
  annotation_scale(
    location = "br",
    text_cex = 3
  ) +
  scale_shape_manual(values = c(1, 2)) +
  scale_colour_manual(values = c("black", "red")) +
  theme_nothing() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = .5),
    text = element_text(size = 42)
  )

inset

# make full plot
base <- ggplot(data = worldmap) +
  geom_sf(
    fill = "#c4cfc8",
    color = "#4b4949d0",
    lwd = 0.2
  ) +
  coord_sf(
    xlim = c(-11, 15),
    ylim = c(49.5, 60)
  ) +
  geom_point(data = map_data, aes(x = lon, y = lat), size = 0.2) +
  geom_rect(
    aes(
      xmin = points_area$xmin[[1]] - 0.1, xmax = points_area$xmax[[1]] + 0.1,
      ymin = points_area$ymin[[1]] - 0.1, ymax = points_area$ymax[[1]] + 0.1
    ),
    fill = NA,
    colour = "black",
    size = .02
  ) +
  theme_nothing() +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, size = .5)
  )

merge_plot <- base +
  annotation_custom(
    ggplotGrob(inset),
    xmin = 1,
    xmax = 13,
    ymin = 52.5,
    ymax = 60
  )

merge_plot

ggsave(
  plot = merge_plot,
  filename = "results/figures/site_map.png",
  width = 183,
  height = 190,
  units = "mm",
  dpi = 300
)


sites_model_plot <- plot_grid(
  all_sites$STU$fit, all_sites$ZSL$fit, aic_plot, ks_plot_dist,
  labels = c("A", "B", "C", "D"), label_size = 42
)

sites_model_plot

ggsave(
  plot = sites_model_plot,
  filename = "results/figures/results_model_plot.png",
  width = 183,
  height = 190,
  units = "mm",
  dpi = 300
)
```
